pipeline {
    agent any
    
    parameters {
        string(name: 'EC2_IP', description: 'Enter your EC2 instance IP address')
        string(name: 'DOCKER_IMAGE', description: 'Enter the Docker image to pull')
    }

    stages {
        stage('SSH to EC2 and Run Docker Container') {
            steps {
                script {
                    // Load SSH key into environment variable
                    withCredentials([string(credentialsId: 'ec2-ssh-key-1', variable: 'SSH_KEY')]) {
                        // Save the SSH key to a file and set permissions
                        def keyFile = "${env.WORKSPACE}/ec2_key.pem"
                        writeFile file: keyFile, text: SSH_KEY
                        sh "chmod 400 ${keyFile}"
                        
                        // Create an SSH command to execute the required commands on the EC2 instance
                        def sshCommand = """
                            ssh -i ${keyFile} -o StrictHostKeyChecking=no ubuntu@${params.EC2_IP} << EOF
                            sudo docker pull ${params.DOCKER_IMAGE}
                            sudo docker run -d -p 8081:8081 ${params.DOCKER_IMAGE}
                            EOF
                        """
                        
                        // Execute the SSH command
                        sh sshCommand
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo 'Docker container started successfully!'
        }
        failure {
            echo 'Failed to start Docker container. Please check the logs for details.'
        }
        always {
            cleanWs()
        }
    }
}
